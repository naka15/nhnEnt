<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="twoyears.givook.trade">

   <select id="selectTradeByNoticeNo" resultType="String"
      parameterType="map">
      select userId from favorite where noticeno=${noticeNo}
   </select>

   <select id="selectusernick" resultType="com.twoyears.model.dto.UsersDTO"
      parameterType="map">
      select * from users where userid=#{userId}
   </select>
   <select id="selectNick" resultType="String" parameterType="map">
      select userId from notice where noticeno=#{noticeNo}
   </select>

   <select id="insertTrade" parameterType="map" resultType="Integer">
      insert
      into trade values(#{userId},#{noticeNo},sysdate, 1, 1)
   </select>

   <select id="getTradeByNoticeNo" parameterType="map"
      resultType="com.twoyears.model.dto.tradeDTO">
      select * from trade where noticeNo=#{noticeNo}
   </select>

   <select id="deleteTrade" parameterType="map" resultType="Integer">
      delete
      from trade where noticeNo=#{noticeNo}
   </select>

   <select id="selectNoticeByUserId" parameterType="map" resultType="com.twoyears.model.dto.NoticeDTO">
      select * from notice where userid=#{userId}
   </select>

   <select id="selectNoticeByNoticeNo" parameterType="map" resultMap="tradeinfo">
      select receiverUserId, noticeNo, to_char(tradeDate,'yyyy/mm/dd hh:mi:ss') "tradeDate", senderStatus, receiverStatus
      from  trade where noticeno=#{noticeno}
   </select>
   
   <select id="selectTradeByUserId" parameterType="map" resultMap="tradeinfo">
      select receiverUserId, noticeNo, to_char(tradeDate,'yyyy/mm/dd hh:mi:ss') "tradeDate", senderStatus, receiverStatus
      from  trade where receiverUserId=#{userId}
   </select>
	<select id="selectTradeByUserIdP" parameterType="map" resultMap="tradeinfo">
		select * from
      (select rownum as rn, t1.* from
      (select receiverUserId, noticeNo, to_char(tradeDate,'yyyy/mm/dd hh:mi:ss') "tradeDate", senderStatus, receiverStatus
      from  trade where receiverUserId=#{userId}) t1
      )
      where rn between ${low2} and ${high2}
	</select>
   <resultMap type="com.twoyears.model.dto.tradeDTO" id="tradeinfo">
      <result property="receiverUserId" column="receiverUserId" />
      <result property="noticeNo" column="noticeNo" />
      <result property="tradeDate" column="tradeDate" />
      <result property="senderStatus" column="senderStatus" />
      <result property="receiverStatus" column="receiverStatus" />
      <association property="receiverUserNick" column="receiverUserId" select="selectUserNick"/>
      <association property="notice" column="noticeNo"
         select="selectByNoticeNo"/>
   </resultMap>

   <select id="selectUserNick" resultType="String">
      select userNick from users where userId=#{receiverUserId}
   </select>

   <select id="selectByNoticeNo" resultType="com.twoyears.model.dto.NoticeDTO">
      select * from
      notice where noticeNo=#{noticeNo}
   </select>
   
   <select id="updateStatus" parameterType="map">
      update trade set receiverstatus=2 where noticeno=#{noticeNo}
   </select>
   
   <select id="updatePointofsender" parameterType="map">
      update users set userpoint=userpoint+100 where userid=#{sender}
   </select>
   
   <select id="updatePointofreceiver" parameterType="map">
      update users set userpoint=userpoint-100 where userid=#{receiver}
   </select>
   
</mapper>